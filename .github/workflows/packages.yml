name: Packages

on: [push]

env:
  DOCKER_BUILDKIT: 1
jobs:

  get-info:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install python.
        uses: actions/setup-python@v2
        with:
          python-version: '3.8.10'

      - name: Prepare environment for the tests.
        id: prepare
        uses: ./.github/actions/run-environment-deployer
        with:
          names: 'base_environment'

      - run: |
          python3 tests/package_tests/package_test_runner.py get-test-specs deb_x86_64
          echo "::set-output name=package-test-targets::$(python3 tests/package_tests/package_test_runner.py get-test-specs deb_x86_64)"


  call-workflow-1:
    needs: get-info
    uses: scalyr/scalyr-agent-2/.github/workflows/package-build-and-test.yml@refactor-tests
    with:
      package_name: deb_x86_64
      os: ubuntu-20.04
      test-targets: ${{ needs.get-info.outputs.package-test-targets }}