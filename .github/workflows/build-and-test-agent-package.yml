on:
  workflow_call:
    inputs:
      package_name:
        required: true
        type: string
      os:
        default: ubuntu-20.04
        required: false
        type: string
      python-version:
        required: false
        type: string
        default: 3.8.10

    #      package-build-spec:
#        required: true
#        type: string
#
#      test-specs:
#        required: false
#        type: string

    secrets:
      SCALYR_PROD_CLOUDTECH_TESTING_WRITE_TOKEN:
        required: true

env:
  DOCKER_BUILDKIT: 1
jobs:
  get-build-and-test-specs:
    runs-on: ${{ inputs.os }}
    outputs:
      package-build-spec: ${{ steps.package-info.outputs.package-build-spec }}
      package-test-specs: ${{ steps.package-info.outputs.package-test-specs }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install python.
        uses: actions/setup-python@v2
        with:
          python-version: ${{ inputs.python-version }}

      - id: package-info
        run: |
          python3 agent_tools/build_and_test_specs.py get-package-build-spec-info ${{ inputs.package_name }}
          python3 agent_tools/build_and_test_specs.py get-package-test-specs ${{ inputs.package_name }}
          echo "::set-output name=package-build-spec::$(python3 agent_tools/build_and_test_specs.py get-package-build-spec-info ${{ inputs.package_name }})"
          echo "::set-output name=package-test-specs::$(python3 agent_tools/build_and_test_specs.py get-package-test-specs ${{ inputs.package_name }})"

  build:
    runs-on: ${{ inputs.os }}
    needs: get-build-and-test-specs
    strategy:
      matrix: ${{fromJSON(needs.get-build-and-test-specs.outputs.package-build-spec)}}
#        package_type: ["deb_x86_64", "rpm_x86_64", "tar_x86_64", "deb_arm64", "rpm_arm64", "tar_arm64"]
#        os: [ubuntu-20.04]
#        python-version: ["3.8"]
#        include:
#          - package_type: ${{ inputs.package_name }}
#            os: ${{ inputs.os }}
#            python-version: "3.8"
#          - package_type: "k8s"
#            os: ubuntu-20.04
#            python-version: "3.8"
#          - package_type: "docker-json"
#            os: ubuntu-20.04
#            python-version: "3.8"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install python.
        uses: actions/setup-python@v2
        with:
          python-version: ${{ inputs.python-version }}


#      - name: Get information about deployers which are used to build '${{ matrix.package_type }}' package.
#        id: get-deployers-info
#        run: |
#          echo "::set-output name=deployer-names::$(python build_package.py get-build-spec ${{ matrix.package_type }} deployers)"
#          echo "::set-output name=deployer-base-image::$(python build_package.py get-build-spec ${{ matrix.package_type }} base-docker-image)"
#          echo "::set-output name=architecture::$(python build_package.py get-build-spec ${{ matrix.package_type }} architecture)"
#
#      - name: Prepare build environment by running appropriate deployer.
#        if: ${{ steps.get-deployers-info.outputs.deployer-names }}
#        id: prepare
#        uses: ./.github/actions/run-environment-deployer
#        with:
#          names: ${{ steps.get-deployers-info.outputs.deployer-names }}
#          base-docker-image: ${{ steps.get-deployers-info.outputs.deployer-base-image }}
#          architecture: ${{ steps.get-deployers-info.outputs.architecture }}

      - name: Set up QEMU
        if: ${{ !startsWith(inputs.package_name, 'msi') }}
        uses: docker/setup-qemu-action@v1
        with:
          platforms: all

      - name: Prepare build environment by running appropriate deployer.
        if: ${{ matrix.deployers }}
        id: prepare
        uses: ./.github/actions/run-environment-deployer
        with:
          names: ${{ matrix.deployers }}
          base-docker-image: ${{ matrix.base-docker-image }}
          architecture: ${{ matrix.architecture }}

#      - name: Build.
#        id: build
#        shell: bash
#        run: |
#          python build_package.py ${{ inputs.package_name }} --output-dir agent-build-output
#          #echo "::set-output name=package-filename-glob::$(python build_package.py get-build-spec ${{ matrix.package_type }} package-filename-glob)"
#
#
#      - name: Save the package.
#        uses: actions/upload-artifact@v2
#        with:
#          name: package-${{ inputs.package_name }}
#          path: |
#            agent-build-output/${{ matrix.package-filename-glob }}*


#  test:
#    needs: [get-build-and-test-specs,build]
#    runs-on: ${{ inputs.os }}
#    strategy:
#      matrix: ${{fromJSON(needs.get-build-and-test-specs.outputs.package-test-specs) }}
#
#    steps:
#      - name: Checkout repository
#        uses: actions/checkout@v2
#
#      - name: Install python.
#        uses: actions/setup-python@v2
#        with:
#          python-version: ${{ inputs.python-version }}
#
#      - name: Prepare build environment by running appropriate deployer.
#        if: ${{ matrix.deployers }}
#        uses: ./.github/actions/run-environment-deployer
#        with:
#          names: ${{ matrix.deployers }}
#          base-docker-image: ${{ matrix.base-docker-image }}
#          architecture: ${{ matrix.architecture }}
#
#      - name: Prepare environment for the tests.
#        uses: ./.github/actions/run-environment-deployer
#        with:
#          names: 'base_environment'
#
#      - name: Download package.
#        uses: actions/download-artifact@v2
#        with:
#          name: package-${{ inputs.package_name }}
#          path: ~/package
#
#      - name: Start minikube for the test of the kubernetes build.
#        if: inputs.package_name == 'k8s'
#        shell: bash
#        run: |
#          minikube start
#
#      # All downloaded artifacts lose their permissions, so we have to make script executable once more.
#      - name: Make Kubernetes and docker package builder scripts executable.
#        if: inputs.package_name == 'k8s' || inputs.package_name == 'docker-json'
#        run: |
#          chmod +x ~/package/*
#
#      - name: Set up QEMU
#        id: qemu
#        uses: docker/setup-qemu-action@v1
#        with:
#          platforms: all
#
#      - name: Test.
#        shell: bash
#        env:
#          SCALYR_PROD_CLOUDTECH_TESTING_WRITE_TOKEN: ${{ secrets.SCALYR_PROD_CLOUDTECH_TESTING_WRITE_TOKEN }}
#        run: |
#
#          python3 tests/package_tests/package_test_runner.py \
#            run \
#            ${{ matrix.spec_name }} \
#            --package-path ~/package/* \
#            --scalyr-api-key "$SCALYR_PROD_CLOUDTECH_TESTING_WRITE_TOKEN"
