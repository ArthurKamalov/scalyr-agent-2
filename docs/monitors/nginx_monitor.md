/// DECLARE path=/help/monitors/nginx
/// DECLARE title=Nginx Monitor
/// DECLARE section=help
/// DECLARE subsection=monitors

# Nginx Monitor

The Nginx monitor allows you to collect data about the usage and performance of your Nginx server.

Each monitor can be configured to monitor a specific Nginx instance, thus allowing you to configure alerts and the
dashboard entries independently (if desired) for each instance.

## Configuring Nginx

To use Scalyr's Nginx monitor, you will need to configure your Nginx server to enable the status module,
which server a status page containing information the monitor will extract.  For more details about this module,
please refer to the
[Nginx status module documentation page](http://nginx.org/en/docs/http/ngx_http_stub_status_module.html).

You will first need to verify that your Nginx server supports the status module.  You can do this by executing
the following command:

    nginx -V 2>&1 | grep -o with-http_stub_status_module

If the command outputs ``with-http_stub_status_module``, then your server supports the status module and you
may proceed to the next step.  If it does not, then your Nginx instance was not compiled with the
``--with-http_stub_status_module`` flag.  You will need to either recompile Nginx or upgrade a full version of Nginx
that has been compiled with that flag.

To enable the status module, you must update the ``server`` configuration section of your Nginx server.  This
configuration can either be found in the ``nginx.conf`` file or in a file in your ``sites-available`` directory.
The full path for these will depend on your system, but for most Linux systems, they are ``/etc/nginx/nginx.conf``
and ``/etc/nginx/sites-available``.

Add the following configuration to the ``server`` configuration section (somewhere in the ``server { ... }`` stanza):

    location /nginx_status {
      stub_status on;      # enable the status module
      allow 127.0.0.1;     # allow connections from localhost only
      deny all;            # deny every other connection
    }

This block does a couple of very important things.  First, it specifies that the status page will be exposed on the
local server at ``http://<address>/nginx_status``.  ``stub_status on`` is what actually enables the module.  The next
two  statements work together and are probably the most important for security purposes.  ``allow 127.0.0.1`` says
that server status URL can only be accessed by the localhost.  The second entry ``deny all`` tells the server to
disallow  connections from every other machine but the one specified in the allow clause.

If you decide that there is a need to allow access to the server status beyond just the local machine, it is
recommended that you consult the Nginx documentation.

One thing to consider in the above stanzas, each access to the ``/nginx_status`` URL will be logged in the Nginx access
log.  If you wish to change this, add the line ``access_log off;`` to the above configuration.

Once you make the configuration change, you will need to restart Nginx.  On most Linux systems, you may do this
with:

    sudo service nginx restart

## Configuring the Nginx Monitor

The Nginx monitor is included with the Scalyr agent.  In order to configure it, you will need to add its monitor
configuration to the Scalyr agent config file.

A basic Nginx monitor configuration entry might resemble:

    monitors: [
      {
          module: "scalyr_agent.builtin_monitors.nginx_monitor",
      }
    ]

If you were running an instances of Nginx on a non-standard port (say 8080), your config might resemble:

    monitors: [
      {
          module: "scalyr_agent.builtin_monitors.nginx_monitor",
          status_url: "http://localhost:8080/nginx_status"
          id: "customers"
      }
    ]

Note the ``id`` field in the configurations.  This is an optional field that allows you to specify an identifier
specific to a particular instance of Nginx and will make it easier to filter on metrics specific to that
instance.

## Configuration reference

The table below describes the options that can be used to configure the Nginx monitor.

|||# Option            ||| Usage
|||# ``module``        ||| Always ``scalyr_agent.builtin_monitors.nginx_monitor``
|||# ``status_url``    ||| Optional (defaults to 'http://localhost/nginx_status').  The URL the monitor will fetchto \
                           retrieve the nginx status information.
|||# ``source_address``||| Optional (defaults to '127.0.0.1'). The IP address to be used as the source address when \
                           fetching the status URL.  Many servers require this to be 127.0.0.1 because they only \
                           server the status page to requests from localhost.
|||# ``id``            ||| Optional (defaults to empty string).  Included in each log message generated by this \
                           monitor, as a field named ``instance``. Allows you to distinguish between different Nginx \
                           instances running on the same server.

## Log reference

Each event recorded by this plugin will have the following fields:

|||# Field        ||| Meaning
|||# ``monitor``  ||| Always ``nginx_monitor``.
|||# ``instance`` ||| The ``id`` value from the monitor configuration.
|||# ``metric``   ||| The metric name.  See the metric tables for more information.
|||# ``value``    ||| The value of the metric.

## Metric reference

The table below describes the metrics recorded by the Nginx monitor.

|||# Metric                        ||| Description
|||# ``nginx.connections.active``  ||| This is the number of connections currently opened to the server.  The total \
                                       number of allowed connections is a function of the number of worker_processes \
                                       and the number of worker_connections configured within your Nginx configuration \
                                       file.
|||# ``nginx.connections.reading`` ||| The number of connections currently reading from the clients.
|||# ``nginx.connections.writing`` ||| The number of connections currently writing to the clients.
|||# ``nginx.connections.waiting`` ||| The number of connections currently idle/sending keep alives.
