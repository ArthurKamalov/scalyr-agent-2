# Base image that creates all necessary dependencies for the scalyr-agent docker image.
# NOTE: multi-stage builds require Docker 17.05 or greater

# Suffix for the python dockerhub image. For now can be: python:slim or python:alpine
ARG PYTHON_BASE_IMAGE_NAME

FROM $PYTHON_BASE_IMAGE_NAME as scalyr-dependencies
MAINTAINER Scalyr Inc <support@scalyr.com>

ARG PYTHON_BASE_IMAGE_NAME
# Build-it argument of the docker builder itself that contains variant of the current target architecture.
ARG TARGETVARIANT
# Set this env. variable to build test version of the agent image.
ARG TESTING

ADD agent_build/docker/install-base-image-build-dependencies.sh agent_build/docker/install-base-image-build-dependencies.sh
RUN PYTHON_BASE_IMAGE_NAME=$PYTHON_BASE_IMAGE_NAME sh agent_build/docker/install-base-image-build-dependencies.sh

ADD agent_build/docker/install-base-image-rust.sh agent_build/docker/install-base-image-rust.sh
RUN TARGETVARIANT=$TARGETVARIANT sh agent_build/docker/install-base-image-rust.sh

ADD agent_build/requirement-files/docker-image-requirements.txt agent_build/requirement-files/docker-image-requirements.txt
ADD agent_build/requirement-files/compression-requirements.txt agent_build/requirement-files/compression-requirements.txt
ADD agent_build/requirement-files/main-requirements.txt agent_build/requirement-files/main-requirements.txt

ADD agent_build/docker/install-base-image-agent-dependencies.sh agent_build/docker/install-base-image-agent-dependencies.sh
RUN TARGETVARIANT=$TARGETVARIANT PYTHON_BASE_IMAGE_NAME=$PYTHON_BASE_IMAGE_NAME TESTING=$TESTING sh agent_build/docker/install-base-image-agent-dependencies.sh

# Install packages and tools that will be required during the final image build.
FROM $PYTHON_BASE_IMAGE_NAME
MAINTAINER Scalyr Inc <support@scalyr.com>

ARG PYTHON_BASE_IMAGE_NAME

ADD agent_build/docker/install-base-image-dependencies.sh agent_build/docker/install-base-image-dependencies.sh
RUN PYTHON_BASE_IMAGE_NAME=$PYTHON_BASE_IMAGE_NAME sh agent_build/docker/install-base-image-dependencies.sh

# Copy Agent's Python dependencies, so they also can be used in the final image build.
COPY --from=scalyr-dependencies  /tmp/dependencies/. /tmp/dependencies
WORKDIR /
