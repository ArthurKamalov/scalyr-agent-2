# Base image that creates all necessary dependencies for the scalyr-agent docker image.
# NOTE: multi-stage builds require Docker 17.05 or greater

# Suffix for the python dockerhub image. For now can be:
#   - 'slim' for debian based image
#   - 'alpine' for alpine based image.
ARG BASE_IMAGE_SUFFIX

# Install dependency packages for debian.
FROM python:3.8.12-$BASE_IMAGE_SUFFIX as base
MAINTAINER Scalyr Inc <support@scalyr.com>

ARG BASE_IMAGE_SUFFIX

ADD agent_build/docker/install-common-dependencies.sh agent_build/docker/install-common-dependencies.sh
RUN BASE_IMAGE_SUFFIX=$BASE_IMAGE_SUFFIX sh agent_build/docker/install-common-dependencies.sh

FROM base as scalyr-dependencies
MAINTAINER Scalyr Inc <support@scalyr.com>

ARG BASE_IMAGE_SUFFIX
ARG TARGETVARIANT
ARG COVERAGE_VERSION

ADD agent_build/requirement-files/docker-image-requirements.txt agent_build/requirement-files/docker-image-requirements.txt
ADD agent_build/requirement-files/compression-requirements.txt agent_build/requirement-files/compression-requirements.txt
ADD agent_build/requirement-files/main-requirements.txt agent_build/requirement-files/main-requirements.txt

ADD agent_build/docker/install-base-image-dependencies.sh agent_build/docker/install-base-image-dependencies.sh
ADD agent_build/docker/install-build-dependencies.sh agent_build/docker/install-build-dependencies.sh
RUN BASE_IMAGE_SUFFIX=$BASE_IMAGE_SUFFIX sh agent_build/docker/install-build-dependencies.sh


RUN TARGETVARIANT=$TARGETVARIANT BASE_IMAGE_SUFFIX=$BASE_IMAGE_SUFFIX sh agent_build/docker/install-base-image-dependencies.sh

# Install packages and tools that will be required during the final image build.
FROM base as ready-base
MAINTAINER Scalyr Inc <support@scalyr.com>

# Copy Agent's Python dependencies, so they also can be used in the final image build.
COPY --from=scalyr-dependencies  /tmp/dependencies/ /tmp/dependencies/
WORKDIR /
